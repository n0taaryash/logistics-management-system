<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Generation Form</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .form-section {
            margin-bottom: 25px;
        }
        .form-section h2 {
            color: #3498db;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e5ea;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dce4ec;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }
        button {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3498db;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        table th, table td {
            padding: 10px;
            border: 1px solid #dce4ec;
        }
        table th {
            background-color: #f0f4f8;
            text-align: left;
            font-weight: 600;
        }
        .add-row-button {
            background-color: #3498db;
            padding: 8px 15px;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .items-table input {
            width: 100%;
            padding: 5px;
            border: 1px solid #dce4ec;
            border-radius: 3px;
        }
        .remove-row {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 12px;
            width: auto;
        }
        .total-row {
            font-weight: 700;
            background-color: #f0f4f8;
        }
        .readonly {
            background-color: #f5f7fa;
            cursor: not-allowed;
        }
    </style>
    <script src="js/api-service.js"></script>
</head>
<body>
    <h1>Bill Generation Form</h1>
    <div class="form-container">
        <form id="billForm">
            <div class="form-section">
                <h2>Bill Information</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="toMs">TO M/S:</label>
                        <input type="text" id="toMs" name="toMs" required>
                    </div>
                    <div class="form-group">
                        <label for="billNo">BILL NO:</label>
                        <input type="text" id="billNo" name="billNo" required>
                    </div>
                    <div class="form-group">
                        <label for="date">DATE:</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>Items</h2>
                <table id="itemsTable" class="items-table">
                    <thead>
                        <tr>
                            <th>Sr.No</th>
                            <th>L.R.No</th>
                            <th>Date</th>
                            <th>Vehicle No.</th>
                            <th>Destination</th>
                            <th>Invoice No.</th>
                            <th>Weight</th>
                            <th>Rate</th>
                            <th>Extra</th>
                            <th>TOTAL</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr>
                            <td>1</td>
                            <td><input type="text" name="lrNo" required></td>
                            <td><input type="date" name="itemDate" required></td>
                            <td><input type="text" name="vehicleNo" required></td>
                            <td><input type="text" name="destination" required></td>
                            <td><input type="text" name="invoiceNo" required></td>
                            <td><input type="number" name="weight" step="0.01" required class="calc"></td>
                            <td><input type="number" name="rate" required class="calc"></td>
                            <td><input type="number" name="extra" value="0" class="calc"></td>
                            <td><input type="number" name="total" readonly class="readonly"></td>
                            <td><button type="button" class="remove-row">Remove</button></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="8" style="text-align: right; font-weight: bold;">GRAND TOTAL</td>
                            <td></td>
                            <td><input type="number" id="grandTotal" readonly class="readonly"></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                <button type="button" id="addRow" class="add-row-button">Add Row</button>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="amountInWords">Amount In Words:</label>
                        <input type="text" id="amountInWords" readonly class="readonly">
                    </div>
                </div>
            </div>

            <button type="submit">Generate Bill</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const itemsTableBody = document.getElementById('itemsTableBody');
            const addRowButton = document.getElementById('addRow');
            const form = document.getElementById('billForm');
            
            // Check if we're editing an existing bill
            const urlParams = new URLSearchParams(window.location.search);
            const isEdit = urlParams.get('edit') === 'true';
            let editBillId = null;
            
            // Load bill data if editing
            if (isEdit) {
                editBillId = urlParams.get('id');
                if (editBillId) {
                    const bill = await fetchBillById(editBillId);
                    if (bill) {
                        populateFormWithBillData(bill);
                    } else {
                        alert('Bill not found. Creating a new bill instead.');
                    }
                }
            } else {
                // For new bills, generate a bill number
                document.getElementById('billNo').value = await generateBillNumber();
            }
            
            // Populate form with bill data for editing
            function populateFormWithBillData(bill) {
                document.getElementById('toMs').value = bill.toMs;
                document.getElementById('billNo').value = bill.billNo;
                
                // Convert date format from DD.MM.YYYY to YYYY-MM-DD for input[type=date]
                const dateParts = bill.date.split('.');
                if (dateParts.length === 3) {
                    const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                    document.getElementById('date').value = formattedDate;
                }
                
                // Remove existing rows except the first one
                while (itemsTableBody.rows.length > 1) {
                    itemsTableBody.deleteRow(itemsTableBody.rows.length - 1);
                }
                
                // Populate items
                bill.items.forEach((item, index) => {
                    if (index === 0) {
                        // Populate first row
                        const firstRow = itemsTableBody.rows[0];
                        populateRowWithItemData(firstRow, item);
                    } else {
                        // Add new rows for additional items
                        addRowButton.click();
                        const newRow = itemsTableBody.rows[itemsTableBody.rows.length - 1];
                        populateRowWithItemData(newRow, item);
                    }
                });
                
                // Calculate totals
                calculateGrandTotal();
            }
            
            // Populate a table row with item data
            function populateRowWithItemData(row, item) {
                row.querySelector('[name="lrNo"]').value = item.lrNo || '';
                
                // Convert date format from DD.MM.YYYY to YYYY-MM-DD for input[type=date]
                if (item.date) {
                    const dateParts = item.date.split('.');
                    if (dateParts.length === 3) {
                        const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                        row.querySelector('[name="itemDate"]').value = formattedDate;
                    }
                }
                
                row.querySelector('[name="vehicleNo"]').value = item.vehicleNo || '';
                row.querySelector('[name="destination"]').value = item.destination || '';
                row.querySelector('[name="invoiceNo"]').value = item.invoiceNo || '';
                row.querySelector('[name="weight"]').value = item.weight || '';
                row.querySelector('[name="rate"]').value = item.rate || '';
                row.querySelector('[name="extra"]').value = item.extra || '0';
                row.querySelector('[name="total"]').value = item.total || '';
            }
            
            // Add new row to the table
            addRowButton.addEventListener('click', function() {
                const rowCount = itemsTableBody.rows.length + 1;
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${rowCount}</td>
                    <td><input type="text" name="lrNo" required></td>
                    <td><input type="date" name="itemDate" required></td>
                    <td><input type="text" name="vehicleNo" required></td>
                    <td><input type="text" name="destination" required></td>
                    <td><input type="text" name="invoiceNo" required></td>
                    <td><input type="number" name="weight" step="0.01" required class="calc"></td>
                    <td><input type="number" name="rate" required class="calc"></td>
                    <td><input type="number" name="extra" value="0" class="calc"></td>
                    <td><input type="number" name="total" readonly class="readonly"></td>
                    <td><button type="button" class="remove-row">Remove</button></td>
                `;
                itemsTableBody.appendChild(newRow);
                attachCalculationEvents(newRow);
            });
            
            // Remove row functionality
            itemsTableBody.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-row')) {
                    if (itemsTableBody.rows.length > 1) {
                        e.target.closest('tr').remove();
                        renumberRows();
                        calculateGrandTotal();
                    } else {
                        alert('Cannot remove the last row!');
                    }
                }
            });
            
            // Calculate row total when inputs change
            function attachCalculationEvents(row) {
                const calcInputs = row.querySelectorAll('.calc');
                const totalInput = row.querySelector('[name="total"]');
                
                calcInputs.forEach(input => {
                    input.addEventListener('input', function() {
                        const weight = parseFloat(row.querySelector('[name="weight"]').value) || 0;
                        const rate = parseFloat(row.querySelector('[name="rate"]').value) || 0;
                        const extra = parseFloat(row.querySelector('[name="extra"]').value) || 0;
                        
                        const total = (weight * rate) + extra;
                        totalInput.value = Math.round(total);
                        
                        calculateGrandTotal();
                    });
                });
            }
            
            // Renumber rows after deletion
            function renumberRows() {
                const rows = itemsTableBody.rows;
                for (let i = 0; i < rows.length; i++) {
                    rows[i].cells[0].textContent = i + 1;
                }
            }
            
            // Calculate grand total and update amount in words
            function calculateGrandTotal() {
                const totalInputs = document.querySelectorAll('[name="total"]');
                let grandTotal = 0;
                
                totalInputs.forEach(input => {
                    grandTotal += parseFloat(input.value) || 0;
                });
                
                document.getElementById('grandTotal').value = Math.round(grandTotal);
                document.getElementById('amountInWords').value = numberToWords(Math.round(grandTotal));
            }
            
            // Attach calculation events to initial row
            attachCalculationEvents(itemsTableBody.rows[0]);
            
            // Convert number to words
            function numberToWords(num) {
                const single = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE', 'TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];
                const tens = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];
                
                if (num === 0) return 'ZERO';
                
                function convertLessThanOneThousand(n) {
                    if (n === 0) return '';
                    
                    if (n < 20) {
                        return single[n] + ' ';
                    }
                    
                    if (n < 100) {
                        return tens[Math.floor(n / 10)] + ' ' + convertLessThanOneThousand(n % 10);
                    }
                    
                    return single[Math.floor(n / 100)] + ' HUNDRED ' + convertLessThanOneThousand(n % 100);
                }
                
                let words = '';
                let crore = Math.floor(num / 10000000);
                num %= 10000000;
                let lakh = Math.floor(num / 100000);
                num %= 100000;
                let thousand = Math.floor(num / 1000);
                num %= 1000;
                
                if (crore > 0) {
                    words += convertLessThanOneThousand(crore) + 'CRORE ';
                }
                
                if (lakh > 0) {
                    words += convertLessThanOneThousand(lakh) + 'LAKH ';
                }
                
                if (thousand > 0) {
                    words += convertLessThanOneThousand(thousand) + 'THOUSAND ';
                }
                
                words += convertLessThanOneThousand(num);
                
                return words.trim() + ' ONLY';
            }
            
            // Form submission handler
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Create form data object
                const formData = new FormData(form);
                const billData = {
                    id: editBillId || undefined, // Use existing ID if editing
                    toMs: formData.get('toMs'),
                    billNo: formData.get('billNo'),
                    date: formatDate(formData.get('date')),
                    createdAt: new Date().toISOString(),
                    items: [],
                    grandTotal: document.getElementById('grandTotal').value,
                    amountInWords: document.getElementById('amountInWords').value
                };
                
                // Get all rows data
                const rows = itemsTableBody.rows;
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    billData.items.push({
                        srNo: i + 1,
                        lrNo: row.querySelector('[name="lrNo"]').value,
                        date: formatDate(row.querySelector('[name="itemDate"]').value),
                        vehicleNo: row.querySelector('[name="vehicleNo"]').value,
                        destination: row.querySelector('[name="destination"]').value,
                        invoiceNo: row.querySelector('[name="invoiceNo"]').value,
                        weight: row.querySelector('[name="weight"]').value,
                        rate: row.querySelector('[name="rate"]').value,
                        extra: row.querySelector('[name="extra"]').value,
                        total: row.querySelector('[name="total"]').value
                    });
                }
                
                try {
                    // Save bill to server
                    let savedBill;
                    if (editBillId) {
                        savedBill = await updateBill(editBillId, billData);
                    } else {
                        savedBill = await createBill(billData);
                    }
                    
                    if (savedBill) {
                        // Open the bill in a new window
                        window.open(`bill.html?id=${savedBill.id}`, '_blank');
                        
                        // Reset form for new entry or redirect to dashboard if editing
                        if (editBillId) {
                            window.location.href = 'index.html';
                        } else {
                            form.reset();
                            
                            // Reset table to initial state
                            while (itemsTableBody.rows.length > 1) {
                                itemsTableBody.removeChild(itemsTableBody.lastChild);
                            }
                            
                            // Reset the first row values
                            const firstRow = itemsTableBody.querySelector('tr');
                            firstRow.querySelector('[name="lrNo"]').value = '';
                            firstRow.querySelector('[name="itemDate"]').value = '';
                            firstRow.querySelector('[name="vehicleNo"]').value = '';
                            firstRow.querySelector('[name="destination"]').value = '';
                            firstRow.querySelector('[name="invoiceNo"]').value = '';
                            firstRow.querySelector('[name="weight"]').value = '';
                            firstRow.querySelector('[name="rate"]').value = '';
                            firstRow.querySelector('[name="extra"]').value = '0';
                            firstRow.querySelector('[name="total"]').value = '';
                            
                            // Reset grand total and amount in words
                            document.getElementById('grandTotal').value = '';
                            document.getElementById('amountInWords').value = '';
                            
                            // Set new bill number
                            document.getElementById('billNo').value = await generateBillNumber();
                        }
                        
                        // Show success message
                        alert('Bill saved successfully!');
                    } else {
                        alert('Failed to save bill. Please try again.');
                    }
                } catch (error) {
                    console.error('Error saving bill:', error);
                    alert('An error occurred while saving the bill. Please try again.');
                }
            });
            
            // Format date to DD.MM.YYYY
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
            }
        });
    </script>
</body>
</html>
